# iOS API Request Cancellation Fix

## Problem Summary
On iOS, when a user cancels a voice request, the API request times out with a message even after cancellation. The issue was caused by:

1. **Timeout Mismatch**: axios timeout (15s) vs ServerApiService timeout (300s)
2. **Incomplete iOS clearNativeState**: Only cleared callbacks/timers, not specific request state
3. **Request ID Mapping Issue**: Two separate request ID systems (React Native vs Native iOS) with no coordination

## Root Cause
- **React Native Request ID**: Generated by ServerApiService (e.g., `1753861878636-p5hqh42xo`)
- **Native iOS Request ID**: Generated by VoiceModule (e.g., `7121E9C0-AEE8-4E8B-A9FB-DD2E35E26A0A`)
- When cancellation occurred, React Native cleared its own request but didn't clear the corresponding native iOS timeout timer

## Solution Implemented

### 1. Fixed Timeout Configuration
- **File**: `src/api/api.ts`
- **Change**: Aligned axios timeout to 300 seconds for both platforms to match ServerApiService
- **Before**: iOS 15s, Android 45s
- **After**: Both platforms 300s

### 2. Enhanced iOS clearNativeState Method
- **File**: `ios/MobileJarvisNative/VoiceModule.swift`
- **Change**: Added support for clearing specific request state by request ID
- **New Parameter**: Optional `requestId` parameter to clear specific request instead of all requests

### 3. Enabled iOS Native Cleanup
- **File**: `src/utils/nativeCleanup.ts`
- **Change**: Removed Android-only restriction, now supports both platforms
- **Before**: Skipped cleanup on iOS
- **After**: Clears native state on both Android and iOS

### 4. Created Request ID Mapping System
- **File**: `src/utils/requestMapping.ts` (new)
- **Purpose**: Track relationship between React Native and native request IDs
- **Features**: 
  - Store bidirectional mapping
  - Clean up mappings on completion/cancellation
  - Debug logging for troubleshooting

### 5. Updated Cancellation Flow
- **Files**: 
  - `src/api/ServerApiService.ts` - Return cancelled request ID
  - `src/api/useServerApi.ts` - Use mapping to find native request ID
  - `src/voice/VoiceContext.tsx` - Store mapping when request starts, clean up on completion/error

## New Cancellation Flow

1. **Request Start**: Store mapping between React Native ID â†” Native iOS ID
2. **User Cancels**: 
   - Cancel React Native HTTP request
   - Look up corresponding native iOS request ID
   - Call `clearNativeState(nativeRequestId)` to cancel specific native timer
   - Remove mapping to prevent memory leaks
3. **Native iOS**: Cancels the specific timeout timer, preventing timeout message

## Files Modified

### Core Changes
1. `src/api/api.ts` - Fixed timeout configuration
2. `ios/MobileJarvisNative/VoiceModule.swift` - Enhanced clearNativeState method
3. `src/utils/nativeCleanup.ts` - Enabled iOS support
4. `src/utils/requestMapping.ts` - New request ID mapping service
5. `src/api/ServerApiService.ts` - Return cancelled request ID
6. `src/api/useServerApi.ts` - Use mapping for native cleanup
7. `src/voice/VoiceContext.tsx` - Store/cleanup mappings

## Expected Behavior After Fix

### Before Fix
1. User cancels request
2. React Native request cancelled (logs show "Request cancelled")
3. Native iOS timeout timer continues running
4. After 30 seconds: Timeout message appears

### After Fix  
1. User cancels request
2. React Native request cancelled
3. System looks up native iOS request ID via mapping
4. Native iOS timeout timer cancelled immediately
5. No timeout message appears

## Testing Instructions

1. **Start voice conversation** on iOS
2. **Say something** (e.g., "Hello")
3. **Immediately cancel** the request before response
4. **Verify**: No timeout message appears after 30 seconds
5. **Check logs**: Should show specific native request ID being cleared

## Debug Logs to Look For

```
ðŸ”— REQUEST_MAPPING: Mapping RN ID '...' to native ID '...'
ðŸ§¹ CANCEL: Clearing native state for specific request: [native-id]
ðŸ§¹ VoiceModule: Cancelled timeout timer for request: [native-id]
```

If these logs appear during cancellation, the fix is working correctly.